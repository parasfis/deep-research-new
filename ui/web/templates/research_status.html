{% extends "base.html" %}

{% block title %}Research Status - Deep Research Assistant{% endblock %}

{% block head %}
<meta http-equiv="refresh" content="5;url={{ url_for('research_status', task_id=task_id) }}">
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Research Status</h4>
            </div>
            <div class="card-body">
                <div id="status-container">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="mt-3" id="status-text">Initializing research...</h5>
                    </div>
                    
                    <div class="progress mb-4">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    
                    <div id="research-info" class="mb-4">
                        <p><strong>Task ID:</strong> <span id="task-id">{{ task_id }}</span></p>
                        <p><strong>Topic:</strong> <span id="research-topic">Loading...</span></p>
                        <p><strong>Started:</strong> <span id="start-time">Loading...</span></p>
                        <p><strong>Duration:</strong> <span id="duration">0s</span></p>
                    </div>
                    
                    <div id="completed-actions" class="d-none">
                        <a href="{{ url_for('research_report', task_id=task_id) }}" class="btn btn-success me-2">
                            View Report
                        </a>
                        <a href="{{ url_for('generate_pdf', task_id=task_id) }}" class="btn btn-primary">
                            Download PDF
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to format time duration
    function formatDuration(seconds) {
        if (seconds < 60) {
            return Math.floor(seconds) + 's';
        } else if (seconds < 3600) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}m ${remainingSeconds}s`;
        } else {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
    }
    
    // Function to format timestamp
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp * 1000);
        return date.toLocaleTimeString();
    }
    
    // Function to update the status
    function updateStatus() {
        fetch('/api/research/{{ task_id }}/status')
            .then(response => response.json())
            .then(data => {
                // Update progress bar
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = data.progress + '%';
                progressBar.setAttribute('aria-valuenow', data.progress);
                progressBar.textContent = data.progress + '%';
                
                // Update status text
                const statusText = document.getElementById('status-text');
                let statusMessage = 'Initializing research...';
                
                if (data.status === 'planning') {
                    statusMessage = 'Planning research...';
                } else if (data.status === 'researching') {
                    statusMessage = 'Researching...';
                } else if (data.status === 'completed') {
                    statusMessage = 'Research completed!';
                    // Show completed actions
                    document.getElementById('completed-actions').classList.remove('d-none');
                    // Stop auto-refresh
                    document.querySelector('meta[http-equiv="refresh"]').remove();
                } else if (data.status === 'error') {
                    statusMessage = 'Error occurred during research.';
                    progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped', 'bg-primary');
                    progressBar.classList.add('bg-danger');
                }
                
                statusText.textContent = statusMessage;
                
                // Update research info
                document.getElementById('research-topic').textContent = data.topic;
                document.getElementById('start-time').textContent = formatTimestamp(data.start_time);
                document.getElementById('duration').textContent = formatDuration(data.duration);
                
                // If not completed, schedule another update
                if (data.status !== 'completed' && data.status !== 'error') {
                    setTimeout(updateStatus, 2000);
                }
            })
            .catch(error => {
                console.error('Error fetching status:', error);
                setTimeout(updateStatus, 5000); // Retry after 5 seconds
            });
    }
    
    // Start updating status when page loads
    document.addEventListener('DOMContentLoaded', function() {
        updateStatus();
    });
</script>
{% endblock %}